var TcHmi;!function(e){let t;!function(t){let a;!function(t){class a extends e.Controls.System.TcHmiControl{constructor(e,a,r){super(e,a,r),this.__eventManager=new t.EventListenerManager,this.__currentUserGroups=[],this.__isOpen=!1,this.__hasUserGroupPermissions=!0,this.__selectedUserGroup="",this.__eventDestroyers=[],this.__defaultPermissionItems=[],this.__receivedDataSourcesRaw="",this.__dragDropTbSource=null,this.__normalRefreshID=null,this.__updateConfigRefreshID=null,this.__updateCounter=0,this.__isSourceRefresh=!1,this.__certFileHandler=null,this.__localizedElements=new Map,this.__localizationReader=void 0,this.__destroyLocalizationWatch=null,this.__localKeys={Data_Source_Management_TextContent:"Data_Source_Management_TextContent",Data_Source_TextContent:"Data_Source_TextContent",Drop_Source_TextContent:"Drop_Source_TextContent",Publish_Dropped_Source_Tooltip:"Publish_Dropped_Source_Tooltip",Add_New_Source_Tooltip:"Add_New_Source_Tooltip",Reset_Source_Tooltip:"Reset_Source_Tooltip",Delete_Source_Tooltip:"Delete_Source_Tooltip",Save_Source_Tooltip:"Save_Source_Tooltip",Refresh_Source_Tooltip:"Refresh_Source_Tooltip",Source_ID_TextContent:"Source_ID_TextContent",Message_Broker_TextContent:"Message_Broker_TextContent",Broker_Port_TextContent:"Broker_Port_TextContent",Topic_TextContent:"Topic_TextContent",Stream_Topic_TextContent:"Stream_Topic_TextContent",Layout__TextContent:"Layout__TextContent",Stream_System_ID_TextContent:"Stream_System_ID_TextContent",User_ID_TextContent:"User_ID_TextContent",Password_TextContent:"Password_TextContent",With_Certificate_TextContent:"With_Certificate_TextContent",CA_Path_TextContent:"CA_Path_TextContent",CERT_Path_TextContent:"CERT_Path_TextContent",Key_Path_TextContent:"Key_Path_TextContent",Key_Password_TextContent:"Key_Password_TextContent",Status_Obsolete_Tooltip:"Status_Obsolete_Tooltip",Save_Success_Message:"Save_Success_Message",Save_Failed_Message:"Save_Failed_Message",Error_Reading_Sources:"Error_Reading_Sources",Error_Layout_Guid_Invalid:"Error_Layout_Guid_Invalid",Error_Layout_Guid_Empty:"Error_Layout_Guid_Empty",Error_StreamSystemID_Invalid:"Error_StreamSystemID_Invalid",Error_StreamSystemID_Empty:"Error_StreamSystemID_Empty",No_Cert:"No_Cert",Remove_Cert_Request:"Remove_Cert_Request",Add_Cert:"Add_Cert",Remove_Source:"Remove_Source",Select_Cert:"Select_Cert",Remove_Cert:"Remove_Cert",CycleTime:"CycleTime"},this.__htmlCodeCloseIcon='<svg class="tchmi-analytics-control-close tchmi-analytics-text tchmi-box" viewBox="0 0 24 24" width="24px" height="24px"><path d = "M7 7 L17 17 M17 7 L7 17" stroke-width="2" stroke = "currentColor" fill = "none" />></svg>',this.__onResized=()=>()=>{}}__previnit(){super.__previnit(),this.__elTemplateRoot=this.__element.find(".tchmi-analytics-source-manager-popup-template"),this.__elPopupHeader=this.__element.find(".tchmi-analytics-source-managers-popup-header"),this.__elPopupHeaderLabel=this.__element.find(".tchmi-analytics-source-managers-popup-header-label"),this.__elDataSourcesContainer=this.__element.find(".tchmi-analytics-source-manager-popup-datasources-container"),this.__elUserGroupsLabel=this.__element.find(".tchmi-analytics-source-manager-popup-datasources-label"),this.__elPermissionButtonContainer=this.__element.find(".tchmi-analytics-source-manager-popup-permissions-menu-container"),this.__elAddArea=this.__element.find(".tchmi-analytics-source-manager-popup-add-area"),this.__elUploadButton=this.__element.find(".tchmi-analytics-source-manager-popup-upload-button"),this.__elAddButton=this.__element.find(".tchmi-analytics-source-manager-popup-tchmi-analytics-control-add-item-placeholder"),this.__elPermissionCloseBtn=this.__element[0].querySelector(".tchmi-analytics-source-manager-popup-close-button"),this.__elPermissionCloseBtn.backgroundPathColor="black",this.__initLocalizations(),this.__eventManager.addEventListener(this.__elPermissionCloseBtn,"mousedown",()=>this.closePopup()),this.__eventManager.addEventListener(this.__elUploadButton[0],"click",()=>this.__uploadTargetBrowserDrop()),this.__eventManager.addEventListener(this.__elAddButton[0],"click",()=>this.__addNewEntry()),this.__eventManager.addEventListener(this.__elTemplateRoot[0],"dragover",this.__onTargetBrowserDragOver()),this.__eventManager.addEventListener(this.__elTemplateRoot[0],"drop",this.__onBeforeUploadTBDrop()),this.__elAddArea[0].textContent=this.__localizationReader.get(this.__localKeys.Drop_Source_TextContent)}__init(){super.__init()}__attach(){super.__attach()}__detach(){super.__detach()}destroy(){this.__keepAlive||(this.__eventManager.removeEventListeners(),super.destroy())}setDarkMode(t){let a=e.ValueConverter.toBoolean(t);null===a&&(a=this.getAttributeDefaultValueInternal("DarkMode")),a!==this.__darkMode&&(this.__darkMode=a,this.__processDarkMode(),e.EventProvider.raise(this.__id+".onFunctionResultChanged",["getDarkMode"]))}getDarkMode(){return this.__darkMode}__processDarkMode(){}openPopup(){this.__initLocalizations(),this.__isOpen=!0,this.__darkMode?($(".tchmi-analytics-source-manager-popup").addClass("tchmi-analytics-source-manager-popup-dark"),$(".tchmi-analytics-source-manager-popup-datasources-label").addClass("tchmi-analytics-source-manager-popup-datasources-label-dark"),$(".tchmi-analytics-source-manager-popup-label").addClass("tchmi-analytics-source-manager-popup-label-dark")):($(".tchmi-analytics-source-manager-popup").removeClass("tchmi-analytics-source-manager-popup-dark"),$(".tchmi-analytics-source-manager-popup-datasources-label").removeClass("tchmi-analytics-source-manager-popup-datasources-label-dark"),$(".tchmi-analytics-source-manager-popup-label").removeClass("tchmi-analytics-source-manager-popup-label-dark")),this.__selectedUserGroup="",$(this.__elDataSourcesContainer).empty(),this.requestDataSources(),this.__elTemplateRoot.css("display","block"),this.__normalRefreshID=setInterval(()=>this.requestDataSources(),3e4)}closePopup(){this.__isOpen=!1,this.__elTemplateRoot.css("display","none"),clearInterval(this.__normalRefreshID)}__resetContent(){for(const e of this.__elDataSourcesContainer.children())if(e instanceof HTMLDetailsElement){if(e.open)continue;const t=$(e).find(".tchmi-analytics-source-manager-popup-summary");if(null!=t&&t.length>0&&t[0].textContent.includes("<broker>"))continue;this.__elDataSourcesContainer[0].removeChild(e)}else this.__elDataSourcesContainer[0].removeChild(e);this.__eventManager.removeEventListeners("dataSources")}__processReceivedDataSources(){if(this.__isOpen&&""!=this.__receivedDataSourcesRaw){let e=JSON.parse(this.__receivedDataSourcesRaw);null==e&&(e=[]);const a=this.__elDataSourcesContainer.find(".tchmi-analytics-source-manager-popup-details");for(const r of a)if(r instanceof HTMLDetailsElement){const a=r.getAttribute("sourceId");if(null==a)continue;const o=e.find(e=>e.sourceID==a);if(null!=o){if(r.open){const e=$(r).find(".tchmi-analytics-source-manager-popup-summary");null!=e&&e.length>0&&this.__setSummaryHeader(e[0],o,r,o)}else this.__createDataSourceEntry(o,r);e.splice(e.indexOf(o),1)}else t.Guid.isGuidEmpty(a)||this.__elDataSourcesContainer[0].removeChild(r)}for(const t of e)this.__createDataSourceEntry(t)}}__createSummaryString(e,t=!0){return t?`${e.broker}:${e.brokerPort}:${e.streamTopic} - Status: ${e.status}`:`${e.broker}:${e.brokerPort}:${e.streamTopic}`}__createDataSourceEntry(e,t,a=!0){var r;const o=[{label:this.__localKeys.Source_ID_TextContent,value:e.sourceID,isEditable:!1,inputType:"text"},{label:this.__localKeys.Message_Broker_TextContent,value:e.broker,isEditable:!0,inputType:"text"},{label:this.__localKeys.Broker_Port_TextContent,value:e.brokerPort.toString(),isEditable:!0,inputType:"number"},{label:this.__localKeys.Topic_TextContent,value:e.topic,isEditable:!0,inputType:"text"},{label:this.__localKeys.Stream_Topic_TextContent,value:e.streamTopic,isEditable:!0,inputType:"text"},{label:this.__localKeys.CycleTime,value:null===(r=e.cycletime)||void 0===r?void 0:r.toString(),isEditable:!0,inputType:"number"},{label:this.__localKeys.Layout__TextContent,value:e.layout,isEditable:!0,inputType:"text"},{label:this.__localKeys.Stream_System_ID_TextContent,value:e.streamSystemID,isEditable:!0,inputType:"text"},{label:this.__localKeys.User_ID_TextContent,value:e.userID,isEditable:!0,inputType:"text"},{label:this.__localKeys.Password_TextContent,value:e.password,isEditable:!0,inputType:"password"},{label:this.__localKeys.With_Certificate_TextContent,value:e.withCertificates.toString(),isEditable:!0,inputType:"checkbox"},{label:this.__localKeys.CA_Path_TextContent,value:e.ca_CertificateName,isEditable:!0,inputType:"file"},{label:this.__localKeys.CERT_Path_TextContent,value:e.cert_CertificateName,isEditable:!0,inputType:"file"},{label:this.__localKeys.Key_Path_TextContent,value:e.key_CertificateName,isEditable:!0,inputType:"file"},{label:this.__localKeys.Key_Password_TextContent,value:e.key_Pwd,isEditable:!0,inputType:"password"}];null==t?((t=document.createElement("details")).classList.add("tchmi-analytics-source-manager-popup-details"),t.classList.add(e.sourceID),t.setAttribute("sourceId",e.sourceID),a&&this.__elDataSourcesContainer.append(t)):(this.__eventManager.removeEventListeners(e.sourceID),$(t).empty());const s=document.createElement("summary");s.classList.add("tchmi-analytics-source-manager-popup-summary"),this.__setSummaryHeader(s,e,t,e),t.appendChild(s);const i=document.createElement("div");return o.forEach(e=>{const t=document.createElement("div");t.classList.add("tchmi-analytics-source-manager-popup-entry");const a=document.createElement("div");a.textContent=this.__localizationReader.get(e.label),a.classList.add("tchmi-analytics-source-manager-popup-label"),this.__darkMode&&a.classList.add("tchmi-analytics-source-manager-popup-label-dark");const r=document.createElement("input");"number"===e.inputType?(r.setAttribute("type","text"),r.setAttribute("data-tchmi-input-mode","numeric")):r.setAttribute("type",e.inputType),r.setAttribute("value",e.value),r.classList.add("tchmi-analytics-source-manager-popup-input"),r.classList.add(e.label.replace(" ",""));const o=document.createElement("div");if("file"==e.inputType){r.style.visibility="hidden",r.style.width="0px",r.accept=e.label==this.__localKeys.Key_Path_TextContent?".key":".PEM",o.classList.add("tchmi-analytics-source-manager-popup-label"),o.classList.add("tchmi-analytics-source-manager-popup-input-small"),this.__darkMode&&o.classList.add("tchmi-analytics-source-manager-popup-label-dark");const t=document.createElement("div");t.classList.add("tchmi-analytics-source-manager-popup-cert-text"),t.textContent=null==e.value||""==e.value?this.__localizationReader.get(this.__localKeys.No_Cert):e.value;const a=document.createElement("div");a.classList.add("tchmi-analytics-source-manager-popup-cert-button","tchmi-analytics-source-manager-popup-cert-reset"),a.title=this.__localizationReader.get(this.__localKeys.Remove_Cert);const s=document.createElement("div");s.classList.add("tchmi-analytics-source-manager-popup-cert-button","tchmi-analytics-source-manager-popup-cert-upload"),s.title=this.__localizationReader.get(this.__localKeys.Select_Cert),o.appendChild(a),o.appendChild(s),o.appendChild(t),this.__eventManager.addEventListener(s,"click",()=>this.__onCertUploadClicked(r)),this.__eventManager.addEventListener(a,"click",()=>this.__onCertRemoveClicked(t,r)),this.__eventManager.addEventListener(r,"change",()=>this.__onCERTInputChanged(t,r))}else this.__eventManager.addEventListener(r,"change",()=>this.__onInputChanged(r));"checkbox"==e.inputType&&"true"==e.value&&(r.checked=!0),e.isEditable||(r.disabled=!0),t.appendChild(a),""!=o.textContent&&t.appendChild(o),t.appendChild(r),i.appendChild(t)}),t.appendChild(i),t}__onCertUploadClicked(e){e.click()}__onCertRemoveClicked(e,t){confirm(this.__localizationReader.get(this.__localKeys.Remove_Cert_Request))&&(e.textContent=this.__localizationReader.get(this.__localKeys.No_Cert),t.value="")}__onCERTInputChanged(e,t){e.style.fontWeight="bold",t.files.length>0&&(e.textContent=t.files[0].name)}__onInputChanged(e){e.style.fontWeight="bold"}__setSummaryHeader(e,t,a,r){e.textContent=this.__createSummaryString(t);const o=document.createElement("button");o.classList.add("tchmi-analytics-source-manager-popup-button"),o.classList.add("tchmi-analytics-source-manager-refresh-popup-button"),e.appendChild(o),o.title=this.__localizationReader.get(this.__localKeys.Refresh_Source_Tooltip),this.__eventManager.addEventListener(o,"click",this.__refreshEntry(a,r),!1,t.sourceID,"dataSources");const s=document.createElement("button");s.classList.add("tchmi-analytics-source-manager-popup-button"),s.classList.add("tchmi-analytics-source-manager-save-popup-button"),e.appendChild(s),s.title=this.__localizationReader.get(this.__localKeys.Save_Source_Tooltip),this.__eventManager.addEventListener(s,"click",this.__saveEntry(a,r),!1,t.sourceID,"dataSources");const i=document.createElement("button");i.classList.add("tchmi-analytics-source-manager-popup-button"),i.classList.add("tchmi-analytics-source-manager-drop-popup-button"),e.appendChild(i),i.style.backgroundSize="20px,20px",i.title=this.__localizationReader.get(this.__localKeys.Delete_Source_Tooltip),this.__eventManager.addEventListener(i,"click",()=>this.__deleteDataSource(t,a),!1,t.sourceID,"dataSources");const n=document.createElement("button");if(n.classList.add("tchmi-analytics-source-manager-popup-button"),n.classList.add("tchmi-analytics-source-manager-reset-popup-button"),e.appendChild(n),n.style.backgroundSize="20px,20px",n.title=this.__localizationReader.get(this.__localKeys.Reset_Source_Tooltip),this.__eventManager.addEventListener(n,"click",this.__resetEntry(a,t),!1,t.sourceID,"dataSources"),"OK"===t.status)e.style.color="green";else if("INIT"===t.status)e.style.color="blue";else if("NOCONNECTION"===t.status)e.style.color="red";else if("OBSOLETE"===t.status){e.style.color="orange";const t=document.createElement("button");t.classList.add("tchmi-analytics-source-manager-popup-icon"),e.appendChild(t),t.style.background="url(/Beckhoff.TwinCAT.HMI.Analytics.Controls/AnalyticsControl/Icons/warning.svg) center/contain no-repeat",t.title=this.__localizationReader.get(this.__localKeys.Status_Obsolete_Tooltip)}}__resetEntry(e,t){return a=>{this.__createDataSourceEntry(t,e),this.createPopupFnct(`Entry ${this.__createSummaryString(t,!1)} has been reset`,CustomElements.PopupStatus.OK,3e3)}}__refreshEntry(e,t){return a=>{this.__isSourceRefresh=!0,this.__saveEntry(e,t)(a)}}__saveEntry(a,r){return o=>{const s={};if(s.sourceID=a.querySelector(`.${this.__localKeys.Source_ID_TextContent}`).value,s.broker=a.querySelector(`.${this.__localKeys.Message_Broker_TextContent}`).value,s.brokerPort=e.ValueConverter.toNumber(a.querySelector(`.${this.__localKeys.Broker_Port_TextContent}`).value),s.topic=a.querySelector(`.${this.__localKeys.Topic_TextContent}`).value,s.streamTopic=a.querySelector(`.${this.__localKeys.Stream_Topic_TextContent}`).value,s.cycletime=e.ValueConverter.toNumber(a.querySelector(`.${this.__localKeys.CycleTime}`).value),s.layout=a.querySelector(`.${this.__localKeys.Layout__TextContent}`).value,s.streamSystemID=a.querySelector(`.${this.__localKeys.Stream_System_ID_TextContent}`).value,s.userID=a.querySelector(`.${this.__localKeys.User_ID_TextContent}`).value,s.password=a.querySelector(`.${this.__localKeys.Password_TextContent}`).value,s.withCertificates=a.querySelector(`.${this.__localKeys.With_Certificate_TextContent}`).checked,s.key_Pwd=a.querySelector(`.${this.__localKeys.Key_Password_TextContent}`).value,t.Guid.isGuid(s.sourceID)||(s.sourceID=t.Guid.newGuid(!0).toString()),!t.Guid.isGuid(s.layout))return void this.createPopupFnct(this.__localizationReader.get(this.__localKeys.Error_Layout_Guid_Invalid),CustomElements.PopupStatus.ALARM,3e3);if(t.Guid.isGuidEmpty(s.layout))return void this.createPopupFnct(this.__localizationReader.get(this.__localKeys.Error_Layout_Guid_Empty),CustomElements.PopupStatus.ALARM,3e3);if(!t.Guid.isGuid(s.streamSystemID))return void this.createPopupFnct(this.__localizationReader.get(this.__localKeys.Error_StreamSystemID_Invalid),CustomElements.PopupStatus.ALARM,3e3);if(t.Guid.isGuidEmpty(s.streamSystemID))return void this.createPopupFnct(this.__localizationReader.get(this.__localKeys.Error_StreamSystemID_Empty),CustomElements.PopupStatus.ALARM,3e3);let i=a.querySelector(`.${this.__localKeys.CA_Path_TextContent}`),n=a.querySelector(`.${this.__localKeys.CERT_Path_TextContent}`),l=a.querySelector(`.${this.__localKeys.Key_Path_TextContent}`);this.__readFileData(i,n,l,s,r)}}__readFileData(e,t,a,r,o){const s=[e,t,a],i=[];let n=s.length;const l=this;s.forEach((s,c)=>{const _=s.files[0];if(_){const s=new FileReader;s.onload=function(_){const u=_.target.result;s.result.split(",")[1];i[c]=u,n--,0===n&&l.__onCertFilesRead(e,t,a,r,o,i)},s.onerror=function(){console.error("Failed to read file data"),i[c]=null,n--,0===n&&l.__onCertFilesRead(e,t,a,r,o,i)},s.readAsDataURL(_)}else i[c]=null,n--,0===n&&l.__onCertFilesRead(e,t,a,r,o,i)})}__onCertFilesRead(e,t,a,r,o,s){var i,n,l;const c=e.files.length>0,_=null===(i=e.parentElement)||void 0===i?void 0:i.textContent.includes(this.__localizationReader.get(this.__localKeys.No_Cert));c&&!_?(r.ca_CertificateName=e.files.length>0?e.files[0].name:"",r.ca_Certificate=s[0].split(",")[1]):c||_?!c&&_&&(r.ca_CertificateName="",r.ca_Certificate=""):(r.ca_CertificateName=o.ca_CertificateName,r.ca_Certificate=o.ca_Certificate);const u=t.files.length>0,d=null===(n=t.parentElement)||void 0===n?void 0:n.textContent.includes(this.__localizationReader.get(this.__localKeys.No_Cert));u&&!d?(r.cert_CertificateName=t.files.length>0?t.files[0].name:"",r.cert_Certificate=s[1].split(",")[1]):u||d?!u&&d&&(r.cert_CertificateName="",r.cert_Certificate=""):(r.cert_CertificateName=o.cert_CertificateName,r.cert_Certificate=o.cert_Certificate);const p=a.files.length>0,h=null===(l=a.parentElement)||void 0===l?void 0:l.textContent.includes(this.__localizationReader.get(this.__localKeys.No_Cert));p&&!h?(r.key_CertificateName=a.files.length>0?a.files[0].name:"",r.key_Certificate=s[2].split(",")[1]):p||h?!p&&h&&(r.key_CertificateName="",r.key_Certificate=""):(r.key_CertificateName=o.key_CertificateName,r.key_Certificate=o.key_Certificate),this.__saveDataSource(r)}__onTargetBrowserDragOver(){return e=>{e.preventDefault(),this.__elAddArea[0].style.backgroundColor="gray",this.__elAddArea[0].textContent=this.__localizationReader.get(this.__localKeys.Drop_Source_TextContent),this.__elUploadButton[0].style.backgroundColor="lightgray"}}__onBeforeUploadTBDrop(){return t=>{var a,r,o,s,i,n,l,c,_,u,d,p,h,m,y;event.preventDefault();const C=null===(a=t.dataTransfer)||void 0===a?void 0:a.getData("text/plain");this.__elAddArea[0].style.backgroundColor="lightgray";const S=(new DOMParser).parseFromString(C,"text/xml");if("parsererror"===S.documentElement.nodeName)console.error("Error parsing xml");else{const t={},a="/TargetBrowserExportInfo/TargetInfo/MQTTAddress/ConnectionSettings",C=S.evaluate(a,S,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;C?(t.broker=(null===(r=C.querySelector("Broker"))||void 0===r?void 0:r.textContent)||"",t.brokerPort=e.ValueConverter.toNumber((null===(o=C.querySelector("BrokerPort"))||void 0===o?void 0:o.textContent)||""),t.userID=(null===(s=C.querySelector("UserID"))||void 0===s?void 0:s.textContent)||"",t.passwordCrypted=(null===(i=C.querySelector("PasswordCrypted"))||void 0===i?void 0:i.textContent)||"",t.ca_Certificate=(null===(n=C.querySelector("CA_Certificate"))||void 0===n?void 0:n.textContent)||"",t.cert_Certificate=(null===(l=C.querySelector("Cert_Certificate"))||void 0===l?void 0:l.textContent)||"",t.key_Certificate=(null===(c=C.querySelector("Key_Certificate"))||void 0===c?void 0:c.textContent)||"",t.key_PwdCrypted=(null===(_=C.querySelector("Key_PwdCrypted"))||void 0===_?void 0:_.textContent)||"",t.withCertificates=""!=t.ca_Certificate,t.key_Pwd=(null===(u=C.querySelector("Key_Pwd"))||void 0===u?void 0:u.textContent)||""):console.error("could not find mqtt parameter");const g="/TargetBrowserExportInfo/TargetInfo/MQTTAddress",T=S.evaluate(g,S,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;C?(t.topic=(null===(d=T.querySelector("Topic"))||void 0===d?void 0:d.textContent)||"",t.layout=(null===(p=T.querySelector("Layout"))||void 0===p?void 0:p.textContent)||"",t.streamTopic=(null===(h=T.querySelector("StreamTopic"))||void 0===h?void 0:h.textContent)||"",t.streamSystemID=(null===(m=T.querySelector("StreamSystemID"))||void 0===m?void 0:m.textContent)||"",t.cycletime=e.ValueConverter.toNumber(null===(y=T.querySelector("CycleTime"))||void 0===y?void 0:y.textContent)||0):console.error("could not find source parameter"),""!=t.broker&&null!=t.brokerPort&&""!=t.topic&&""!=t.streamTopic&&""!=t.streamSystemID&&""!=t.layout?(this.__dragDropTbSource=t,this.__elAddArea[0].textContent=`${t.broker}:${t.brokerPort}:${t.streamTopic} - Status: Not Initalized `,this.__elUploadButton[0].style.backgroundColor="#339900"):this.createPopupFnct("Some parameter are missing in the dropped source. Please check and try again.",CustomElements.PopupStatus.ALARM,5e3)}}}__uploadTargetBrowserDrop(){if(null!=this.__dragDropTbSource)if(this.__elUploadButton[0].style.backgroundColor="lightgray",e.Controls.Analytics.Str.isNullOrUndefinedOrEmpty(this.__dragDropTbSource.ca_Certificate)&&e.Controls.Analytics.Str.isNullOrUndefinedOrEmpty(this.__dragDropTbSource.cert_Certificate)&&e.Controls.Analytics.Str.isNullOrUndefinedOrEmpty(this.__dragDropTbSource.key_Certificate))this.__dragDropTbSource.ca_Certificate=null,this.__dragDropTbSource.cert_Certificate=null,this.__dragDropTbSource.key_Certificate=null,this.__uploadTBDrop();else{confirm(this.__localizationReader.get(this.__localKeys.Add_Cert))?this.__showCertFilesPopup():(this.__dragDropTbSource.ca_Certificate=null,this.__dragDropTbSource.cert_Certificate=null,this.__dragDropTbSource.key_Certificate=null,this.__uploadTBDrop())}}__uploadTBDrop(){this.__saveDataSource(this.__dragDropTbSource),this.__dragDropTbSource=null,this.__elAddArea[0].textContent=this.__localizationReader.get(this.__localKeys.Drop_Source_TextContent),this.requestDataSources()}__uploadTBDropWithCERT_Files(){let t=this.__certFileHandler.querySelector(`.${this.__localKeys.CA_Path_TextContent}`),a=this.__certFileHandler.querySelector(`.${this.__localKeys.CERT_Path_TextContent}`),r=this.__certFileHandler.querySelector(`.${this.__localKeys.Key_Path_TextContent}`);this.__readFileData(t,a,r,this.__dragDropTbSource,this.__dragDropTbSource),this.__dragDropTbSource=null,this.__elAddArea[0].textContent=this.__localizationReader.get(this.__localKeys.Drop_Source_TextContent),this.requestDataSources(),e.TopMostLayer.remove(this,$(this.__certFileHandler))}__showCertFilesPopup(){this.__certFileHandler=document.createElement("div"),this.__certFileHandler.classList.add("tchmi-analytics-source-manager-popup-cert-file-container");const t=document.createElement("div");t.classList.add("tchmi-analytics-source-manager-popup-cert-file-centered"),this.__darkMode&&t.classList.add("tchmi-analytics-source-manager-popup-cert-file-centered-dark");const a=document.createElement("div");a.classList.add("tchmi-analytics-source-managers-popup-header");const r=document.createElement("div");r.classList.add("tchmi-analytics-source-managers-popup-header-label"),r.textContent=this.__localizationReader.get(this.__localKeys.With_Certificate_TextContent);const o=document.createElement("close-icon");o.classList.add("tchmi-analytics-source-manager-popup-close-button"),o.backgroundPathColor="black",this.__eventManager.addEventListener(o,"click",()=>{e.TopMostLayer.remove(this,$(this.__certFileHandler)),this.__elUploadButton[0].style.backgroundColor="#339900"});const s=document.createElement("button");this.__eventManager.addEventListener(s,"click",()=>this.__uploadTBDropWithCERT_Files()),s.classList.add("tchmi-analytics-source-manager-popup-add-area","tchmi-analytics-source-manager-popup-cert-submit"),s.textContent=this.__localizationReader.get(this.__localKeys.Publish_Dropped_Source_Tooltip);const i=this.__createDataSourceEntry(this.__dragDropTbSource,null,!1),n=i.querySelector(`.${this.__localKeys.CA_Path_TextContent}`).parentElement,l=i.querySelector(`.${this.__localKeys.CERT_Path_TextContent}`).parentElement,c=i.querySelector(`.${this.__localKeys.Key_Path_TextContent}`).parentElement;i.querySelectorAll(".tchmi-analytics-source-manager-popup-input-small").forEach(e=>e.classList.add("tchmi-analytics-source-manager-popup-cert-file-items")),this.__certFileHandler.appendChild(t),t.appendChild(a),a.appendChild(r),a.appendChild(o),t.appendChild(n),t.appendChild(l),t.appendChild(c),t.appendChild(s);e.TopMostLayer.add(this,$(this.__certFileHandler),{modal:!1,closeOnBackground:!0,dimBackground:!0})}__addNewEntry(){const e={broker:"<broker>",brokerPort:1883};e.sourceID=t.Guid.newGuid(!0).toString(),e.topic="<topic>",e.streamTopic="<streamTopic>",e.layout=t.Guid.newGuid(!0).toString(),e.streamSystemID=t.Guid.newGuid(!0).toString(),e.userID="",e.password="",e.withCertificates=!1,e.ca_Certificate="",e.cert_Certificate="",e.key_Certificate="",e.key_Pwd="",this.__createDataSourceEntry(e)}__refreshAfterUpdate(){this.__updateCounter>4?(clearInterval(this.__updateConfigRefreshID),this.__updateCounter=0):(this.requestDataSources(),this.__updateCounter++)}requestDataSources(){const e=new t.UserDataStoreCmd;e.tableName="DataSourcesStorage",e.cmdType=t.I_SE_TableCmdType.GET,e.cmdData="";const a={requestType:"ReadWrite",commands:[{symbol:"TcHmiAnalytics.GetUserData",readValue:"",writeValue:JSON.stringify(e),commandOptions:["SendErrorMessage","SendWriteValue"]}]};this.__requestExSymbol(a)}__saveDataSource(a){const r=new t.UserDataStoreCmd;r.tableName="DataSourcesStorage",r.cmdType=t.I_SE_TableCmdType.SET,r.cmdData=JSON.stringify(a);const o={requestType:"ReadWrite",commands:[{symbol:"TcHmiAnalytics.SetUserData",readValue:"",writeValue:JSON.stringify(r),commandOptions:["SendErrorMessage","SendWriteValue"]}]};this.__requestExSymbol(o),e.EventProvider.raise(`${this.__id}.onPermissionsChanged`),this.__refreshAfterUpdate(),this.__updateConfigRefreshID=setInterval(()=>this.__refreshAfterUpdate(),5e3)}__deleteDataSource(a,r){if(!confirm(this.__localizationReader.get(this.__localKeys.Remove_Source)))return;t.Guid.isGuidEmpty(a.sourceID)&&this.__elDataSourcesContainer[0].removeChild(r);const o=new t.UserDataStoreCmd;o.tableName="DataSourcesStorage",o.cmdType=t.I_SE_TableCmdType.DROP,o.cmdData=JSON.stringify(a);const s={requestType:"ReadWrite",commands:[{symbol:"TcHmiAnalytics.DropUserData",readValue:"",writeValue:JSON.stringify(o),commandOptions:["SendErrorMessage","SendWriteValue"]}]};this.__requestExSymbol(s),e.EventProvider.raise(`${this.__id}.onPermissionsChanged`),this.requestDataSources()}__requestExSymbol(t){let a=this;e.Server.isWebsocketReady()?e.Server.request(t,(function(t){var r=t.response;r&&void 0===r.error||console.log("Error with server-extension communication");var o=r.commands;void 0===o&&console.error("Commands undefined");for(var s=0,i=o.length;s<i;s++){var n=o[s];if("TcHmiAnalytics.SetUserData"===n.symbol){if(1==a.__isSourceRefresh)return void(a.__isSourceRefresh=!1);"Stored data source successfully"===String(n.readValue)?a.createPopupFnct(a.__localizationReader.get(a.__localKeys.Save_Success_Message),CustomElements.PopupStatus.OK,5e3):(a.createPopupFnct(a.__localizationReader.get(a.__localKeys.Save_Failed_Message),CustomElements.PopupStatus.ALARM,5e3),console.error("Error set data source"))}else if("TcHmiAnalytics.GetUserData"===n.symbol){let e=String(n.readValue);null!=e?(a.__receivedDataSourcesRaw=e,a.__processReceivedDataSources()):a.createPopupFnct(a.__localizationReader.get(a.__localKeys.Error_Reading_Sources),CustomElements.PopupStatus.ALARM,5e3)}void 0!==n.error&&console.log("error with server-extension command"),e.Log.debug(n.symbol+"="+n.readValue)}})):console.error("No request send, because websocket connection not ready!")}__initLocalizations(){let t=this.__element[0].querySelectorAll("[data-tchmi-localized-content-key]");for(let e=0,a=t.length;e<a;e++){let a=t[e],r=a.dataset.tchmiLocalizedContentKey;r&&this.__localizedElements.set(a,{key:r})}this.__destroyLocalizationWatch=this.__localization.watch(t=>{if(t.error===e.Errors.NONE&&t.reader){this.__localizationReader=t.reader;for(const[e,a]of this.__localizedElements){let r=t.reader.get(a.key);a.key.includes("Tooltip")?e.title=tchmi_decode_control_characters(r):e.textContent=tchmi_decode_control_characters(r)}}})}}t.SourceManagerPopup=a}(a=t.Analytics||(t.Analytics={}))}(t=e.Controls||(e.Controls={}))}(TcHmi||(TcHmi={})),TcHmi.Controls.registerEx("SourceManagerPopup","TcHmi.Controls.Analytics",TcHmi.Controls.Analytics.SourceManagerPopup);