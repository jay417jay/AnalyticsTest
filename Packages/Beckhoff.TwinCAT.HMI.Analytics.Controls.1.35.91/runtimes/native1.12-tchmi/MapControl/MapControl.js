var TcHmi;!function(e){let t;!function(t){let n;!function(t){class n extends e.Controls.Analytics.AnalyticsControl{constructor(t,n,l){super(t,n,l),this.__isExpanded=!0,this.__expanderMouseClickEvent=null,this.__onResized=()=>(e,t)=>{const n=super.__getScaleFactor();0!=this.__hasLicense&&(this.__showReset=!1,this.__processShowReset(),this.__elementLegend.css("font-size",16*n),this.getRenderedWidth()<=800?(this.__elementOuterMap.addClass("tchmi-map-control-outer-map-mobile"),this.__elementMainLegend.addClass("tchmi-map-control-main-legend-container-mobile")):(this.__elementOuterMap.removeClass("tchmi-map-control-outer-map-mobile"),this.__elementMainLegend.removeClass("tchmi-map-control-main-legend-container-mobile")),this.__processMap())},this.__onResolverForResultsWatchCallback=t=>{if(!1===this.__isAttached&&this.__suspendObjectResolver("MapInput"),t.error!==e.Errors.NONE)return this.CreateDefaultMap(),void e.Log.error("[Source=Control, Module=TcHmi.Controls.Analytics.AnalyticsControl, Id="+this.getId()+", Attribute=MapInput] Resolving symbols from object failed with error: "+e.Log.buildMessage(t.details));tchmi_equal(t.value,this.__mapInput)||(this.__mapInput=t.value||null,e.EventProvider.raise(`${this.__id}.onFunctionResultChanged`,["getMapInput"]),this.__processMap())},this.stackPos=-1}__previnit(){super.__previnit(),0!=this.__hasLicense&&(this.__defaultWidth=950,this.__defaultHeight=470,this.__elementMainLegend=this.__elementTemplateRoot.find(".tchmi-map-control-main-legend-container"),this.__elementLegend=this.__elementMainLegend.find(".tchmi-map-control-legend-container"),this.__elementListElement=this.__elementTemplateRoot.find(".li"),this.__elementMapContainer=this.__elementTemplateRoot.find(".tchmi-map-control-map-container"),this.__elementOuterMap=this.__elementTemplateRoot.find(".tchmi-map-control-outer-map"),this.__elementExpander=this.__elementTemplateRoot.find(".tchmi-map-control-legend-container-expander"),this.__elementExpanderImg=this.__elementExpander.find(".tchmi-map-control-legend-expander"))}__init(){super.__init(),this.__isDarkTheme&&!this.__isExpanded?this.__elementExpanderImg.addClass("tchmi-map-control-legend-expander-white"):this.__elementExpanderImg.removeClass("tchmi-map-control-legend-expander-white")}__attach(){super.__attach();const e=this;this.__elementExpander.click((function(){e.__isExpanded=!e.__isExpanded,e.__isExpanded?(e.__elementMainLegend.addClass("tchmi-map-control-main-legend-container-expanded"),e.__elementOuterMap.addClass("tchmi-map-control-outer-map-expanded"),e.__elementExpander.addClass("tchmi-map-control-legend-container-expander-expanded"),e.__elementExpander.removeClass("tchmi-map-control-legend-container-expander-collapsed"),e.__elementExpanderImg.removeClass("tchmi-map-control-legend-expander-white")):(e.__elementMainLegend.removeClass("tchmi-map-control-main-legend-container-expanded"),e.__elementOuterMap.removeClass("tchmi-map-control-outer-map-expanded"),e.__elementExpander.removeClass("tchmi-map-control-legend-container-expander-expanded"),e.__elementExpander.addClass("tchmi-map-control-legend-container-expander-collapsed"),e.__isDarkTheme&&e.__elementExpanderImg.addClass("tchmi-map-control-legend-expander-white")),e.__processMap()}))}__detach(){super.__detach(),this.__elementExpander.off("click")}destroy(){this.__keepAlive||super.destroy()}setMapInput(t){let n=e.ValueConverter.toObject(t);this.__mapInputSymbol=n,null===n&&(n=this.getAttributeDefaultValueInternal("MapInput"));const l=this.__objectResolvers.get("MapInput");l&&(l.watchDestroyer&&l.watchDestroyer(),l.resolver.destroy());const o=new e.Symbol.ObjectResolver(n);this.__objectResolvers.set("MapInput",{resolver:o,watchCallback:this.__onResolverForResultsWatchCallback,watchDestroyer:o.watch(this.__onResolverForResultsWatchCallback)})}__processColor(){this.__element.find(".p-map-legend").css("color",this.__fontColor),this.__processMap()}__processMap(){if(null!=this.__mapInput){const t=new Array(this.__mapInput.length),n=new Array(this.__mapInput.length),l=new Array(this.__mapInput.length),o=new Array(this.__mapInput.length),i=e.Environment.getControlBasePathEx(this);let s;if(this.__mapInput.length>0){for(let e=0;e<this.__mapInput.length;e++)t[e]=this.__mapInput[e].sPosition,n[e]=this.__mapInput[e].nStatus,l[e]=this.__mapInput[e].sDescription,o[e]=this.__mapInput[e].sName;this.__oldMapInput!=this.__mapInput&&null!=this.__fontColor&&null!=this.__controlColorDark&&null!=this.__controlColorLightPlus&&(this.CreateMap(!0,t,n,this.__elementMapContainer,this.__id,l,o,this.__fontColor,this.__controlColorDark,this.__controlColorLightPlus,i,s),this.__oldMapInput=this.__mapInput)}else this.CreateDefaultMap()}else this.CreateDefaultMap()}CreateDefaultMap(){const t=e.Environment.getControlBasePathEx(this);if(null!=this.__fontColor&&null!=this.__controlColorDark&&null!=this.__controlColorLightPlus){const e=JSON.parse('[{ "sPosition": "Beckhoff Automation, Verl", "nStatus": "0" , "sDescription": "", "sName": "Beckhoff Automation"}]');this.CreateMap(!0,["Beckhoff Automation, Verl"],["0"],this.__elementMapContainer,this.__id,[""],[""],this.__fontColor,this.__controlColorDark,this.__controlColorLightPlus,t,e)}}__processTheme(){super.__processTheme(),this.__isDarkTheme?this.__isExpanded||this.__elementExpanderImg.addClass("tchmi-map-control-legend-expander-white"):this.__elementExpanderImg.removeClass("tchmi-map-control-legend-expander-white")}CreateMap(t,n,l,o,i,s,a,r,p,c,d,m=""){(0==n.length||1==n.length&&""==n[0]||1==n.length&&null==n[0]||1==n.length&&"undefined"==n[0])&&(n=["No position set!"]);const _=L.DomUtil.get(this.__id+"_outermap");null!=_&&(_.innerHTML="<div id='"+this.__id+"_map' class='tchmi-map-control-map-container tchmi-box'></div>"),o=this.__elementTemplateRoot.find(".tchmi-map-control-map-container"),this.__elementMapContainer=o;const h=document.createElement("p");for(h.setAttribute("class","tchmi-map-control-map-container-p"),h.innerHTML="No map found!",void 0!==o&&o[0].appendChild(h),this.__elementLegend=this.__elementTemplateRoot.find(".tchmi-map-control-legend-container");this.__elementLegend[0].firstChild;)this.__elementLegend[0].removeChild(this.__elementLegend[0].firstChild);this.__elementLegend[0].innerHTML="",this.__elementLegend[0].innerText="";const u=this;let g=0,f=0;const y=new L.FeatureGroup,C=L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{noWrap:!0,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',bounds:L.latLngBounds([[-90,-180],[90,180]])});let b,M,k,x;u.__elementMapContainer[0].clientWidth<u.__elementMapContainer[0].clientHeight?(b=u.__elementMapContainer[0].clientWidth,0==b&&(b=1*this.getRenderedWidth()),M=u.__elementMapContainer[0].clientHeight,0==M&&(M=this.getRenderedHeight())):(b=u.__elementMapContainer[0].clientHeight,0==b&&(b=this.getRenderedHeight()),M=u.__elementMapContainer[0].clientWidth,0==M&&(M=1*this.getRenderedWidth())),k=b>100?Math.log2(b/256):2,x=M>100?Math.ceil(Math.log2(M/256)):2;const v=L.map(o[0],{center:new L.LatLng(g,f),zoom:x,minZoom:k,layers:[C,y]}).setView([g,f],x);v.setZoom(x),v.invalidateSize(!1),this.__map=v;const A=L.latLngBounds([[-90,-180],[90,180]]);v.setMaxBounds(A),setTimeout((function(){v.invalidateSize(!0)}),0);const I="legendIcon",E=document.createElement("ul");function w(e){N();const t="<svg id='"+u.__id+"_highlightMarker' xmlns='http://www.w3.org/2000/svg' width='43' height='20' viewBox='0 22 43 22'><path class='ring_outer' fill='#5F5F5F' d='M28.6 23c6.1 1.4 10.4 4.4 10.4 8 0 4.7-7.7 8.6-17.3 8.6-9.6 0-17.4-3.9-17.4-8.6 0-3.5 4.2-6.5 10.3-7.9.7-.1-.4-1.5-1.3-1.3C5.5 23.4 0 27.2 0 31.7c0 6 9.7 10.7 21.7 10.7s21.6-4.8 21.6-10.7c0-4.6-5.7-8.4-13.7-10-.8-.2-1.8 1.2-1 1.4z'/><path class='ring_inner' fill='#5F5F5F' d='M27 25.8c2 .7 3.3 1.8 3.3 3 0 2.2-3.7 3.9-8.3 3.9-4.6 0-8.3-1.7-8.3-3.8 0-1 .8-1.9 2.2-2.6.6-.3-.3-2-1-1.6-2.8 1-4.6 2.7-4.6 4.6 0 3.2 5.1 5.7 11.4 5.7 6.2 0 11.3-2.5 11.3-5.7 0-2-2.1-3.9-5.4-5-.7-.1-1.2 1.3-.7 1.5z'/></svg>",n=L.divIcon({className:"leaflet-data-marker highlightMarker",html:t,iconSize:[43,22]});L.marker(e,{icon:n}).addTo(v)}function N(){$("#"+u.__id+"_highlightMarker").remove(),v.closePopup()}function T(){const e=$("[name='Submit']");for(let t=0;t<e.length;t++)e[t].click(),null!=e[t].parentElement&&(e[t].parentElement.style.display="none");const t=$("p.p-map-legend-highlighted");for(let e=0;e<t.length;e++)t[e].setAttribute("class","p-map-legend");const n=$("#further-description");for(let e=0;e<n.length;e++)n[e].style.display="none"}E.setAttribute("class","ul-map-legend"),E.setAttribute("id",I),this.__elementLegend[0].appendChild(E),++this.stackPos;const R=this.stackPos;for(let t=0;t<n.length;t++)!function(t){let o=n[t],i=o;""!=o&&null!=o&&"undefined"!=o||(o="No position set!");let m=0,_=0,h=!0;if(!o.match(/[^0-9\.;]/)){const e=o.split(";");2==e.length&&(m=parseFloat(e[1]),_=parseFloat(e[0]),isNaN(m)||isNaN(_)||(h=!1))}const C=new XMLHttpRequest;let b;b=h?"https://nominatim.openstreetmap.org/search?format=json&limit=3&q="+i:"https://nominatim.openstreetmap.org/reverse?format=json&lat="+m+"&lon="+_+"&zoom=18&addressdetails=1",C.onreadystatechange=function(C){if(4===this.readyState&&200===this.status){if(R<u.stackPos)return;let C,b=JSON.parse(this.responseText);if(void 0===b.length&&null!=b.address&&(b=[b]),""!==a&&a.length>t&&""!==a[t]&&null!=a[t]?C=a[t]:(C=o,(a[t]="")&&(a[t]=C)),u.__mapInputSymbol[t].sName.startsWith("%s%")){const n=u.__mapInputSymbol[t].sName.replace("%/s%","").replace("%s%","");e.Server.writeSymbol(n,a[t]),u.__oldMapInput[t].sName=a[t]}const M="transparent";if(b.length>0&&"No position set!"!=o||!h){if(b.length>0)i=b[0].lat+" "+b[0].lon;else{i=m+" "+_,b=[{display_name:"No address found for latitude "+m+", longitude "+_+"."}]}(0===t||0===g&&0===f)&&(g=parseFloat(i.split(" ")[0]),f=parseFloat(i.split(" ")[1]),isNaN(g)||isNaN(f)||v.setView([g,f],v.getZoom()));let o="";o=1===l[t]?d+"/Images/marker-icon-green.png":2===l[t]?d+"/Images/marker-icon-yellow.png":3===l[t]?d+"/Images/marker-icon-red.png":d+"/Images/marker-icon-grey.png",function(e,t,n,l,o,i){const s=e.split(/[ :;?!~,`"&|()<>{}\[\]\r\n/\\]+/),a=L.icon({iconUrl:t,iconAnchor:[12,41],popupAnchor:[0,-55],className:"tchmi-marker-Icon"});try{const e=new L.LatLng(parseFloat(s[0]),parseFloat(s[1])),t=new L.Marker(e,{icon:a});t.bindPopup(n),t.on("dblclick",(function(e){l.setView([s[0],s[1]],15)})),t.on("click",(function(l){w(e),T();const o=$("p.p-map-legend");let s=null,a=!1;for(let e=0;e<o.length;e++){if(o[e].innerText==n){if(0!=a){s=i;break}a=!0,s=e}}null==s&&(s=i),o[s].setAttribute("class","p-map-legend-highlighted"),t.openPopup()})),o.addLayer(t)}catch(e){}}(i,o,C,v,y,t),function(t,n,l,o,i,s,a,r,p,c,d,m,_,h,g){const f=document.createElement("li");f.setAttribute("class","li-map-legend");const y='url("'+n+'")',C=document.createElement("div");C.setAttribute("style","background-color: "+p+";background-image: "+y),C.setAttribute("class","legendIcon"),f.appendChild(C);const b=document.createElement("p");b.setAttribute("style","color: "+d),b.setAttribute("class","p-map-legend"),b.setAttribute("id","mapLegendItem"),b.innerText=l,f.appendChild(b);const M=document.createElement("li");M.setAttribute("class","further-description"),M.setAttribute("id","further-description");const k=document.createElement("textarea");k.setAttribute("class","textarea-map-legend"),k.maxLength=5e3,c.length>r&&""!==c[r]?k.innerHTML=c[r]:(k.innerHTML=o,c[r]=o),k.readOnly=!0,k.style.backgroundColor=_,k.style.color=d,M.appendChild(k),f.appendChild(M);const x=document.createElement("input");x.setAttribute("type","submit"),x.setAttribute("name","Submit"),x.setAttribute("value","Submit"),x.setAttribute("style","display: none; float: left; margin: 2px; color: "+d+";"),x.style.backgroundColor=_,M.appendChild(x);const A=document.createElement("input");A.setAttribute("type","button"),A.setAttribute("name","Cancel"),A.setAttribute("value","Cancel"),A.setAttribute("style","display: none;float: left; margin: 2px;color: "+d+";"),A.style.backgroundColor=_,M.appendChild(A);const I=document.createElement("input");I.setAttribute("type","button"),I.setAttribute("name","Edit"),I.setAttribute("value","Edit"),I.setAttribute("style","display: none; float: left;  margin: 2px; color: "+d+";"),I.style.background=_,M.appendChild(I),I.onclick=function(){k.style.backgroundColor="white",I.style.display="none",x.style.display="block",A.style.display="block",k.readOnly=!1,k.style.color="black"},x.onclick=function(){if(x.style.display="none",I.style.display="none",A.style.display="none",k.readOnly=!0,c[r]=k.value,null!=u.__mapInput&&(u.__mapInput[r].sDescription=k.value,u.__mapInputSymbol[r].sDescription.startsWith("%s%"))){const t=u.__mapInputSymbol[r].sDescription.replace("%/s%","").replace("%s%","");e.Server.writeSymbol(t,k.value),u.__oldMapInput[r].sDescription=k.value}k.style.color=d,k.style.backgroundColor=_},A.onclick=function(){x.style.display="none",I.style.display="none",A.style.display="none",k.readOnly=!0,k.value=u.__mapInput[r].sDescription,k.style.color=d,k.style.backgroundColor=_},k.onclick=function(){!0===k.readOnly&&("none"===I.style.display?(I.style.display="block",x.style.display="none",A.style.display="none"):(I.style.display="none",x.style.display="none",A.style.display="none"))},b.ondblclick=function(){a.setView([t.split(" ")[0],t.split(" ")[1]],15),b.click()},b.onclick=function(){if(!("none"===M.style.display||""===M.style.display))T(),N(),v.closePopup(),M.style.display="none",b.setAttribute("class","p-map-legend");else{T(),N(),v.closePopup(),M.style.display="block",b.setAttribute("class","p-map-legend-highlighted"),w(new L.LatLng(parseFloat(t.split(" ")[0]),parseFloat(t.split(" ")[1])))}k.style.color=d,k.style.backgroundColor=_};let E=0;for(let e=0;e<i.childNodes.length;e++)if(i.childNodes[e].id===s){E=e;break}i.childNodes[0].children.length<g&&i.childNodes[E].appendChild(f)}(i,o,C,b[0].display_name,u.__elementLegend[0],I,v,t,M,s,r,p,c,y,n.length)}else{let e;const t=document.createElement("li");if(t.setAttribute("class","li-map-legend"),"No position set!"==o){const n='url("'+(d+"/Images/marker-icon-grey.png")+'")',l=document.createElement("div");l.setAttribute("style","background-color: "+M+";background-image: "+n),l.setAttribute("class","legendIcon"),t.appendChild(l),"No position set!"==C&&(C="No name set"),e=C+':  <span class="mapNoPosition">'+o+"</span>"}else e="Nothing found for:      "+o;const l=document.createElement("p");l.setAttribute("class","p-map-legend"),l.setAttribute("id","mapLegendItem"),l.innerHTML=e;const i="color:"+r;l.setAttribute("style",i),t.appendChild(l);const s=u.__elementTemplateRoot.find(".p-map-legend");n.length>s.length&&u.__elementLegend[0].children[0].appendChild(t)}}},C.open("GET",b,!0),C.send()}(t);const S=L.Control.extend({options:{position:"topleft"},onAdd:function(e){const t=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-custom map-world-extend-button");return t.onclick=function(){e.invalidateSize(!1),e.setView([g,f],e.getMinZoom())},t}});v.addControl(new S);const D=L.Control.extend({options:{position:"topleft"},onAdd:function(e){const t=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-custom map-marker-extend-button");return t.onclick=function(){e.invalidateSize(!1);const t=y.getBounds();e.fitBounds(t,{padding:[20,20]})},t}});v.addControl(new D)}}t.MapControl=n}(n=t.Analytics||(t.Analytics={})),t.registerEx("MapControl","TcHmi.Controls.Analytics",n.MapControl)}(t=e.Controls||(e.Controls={}))}(TcHmi||(TcHmi={}));