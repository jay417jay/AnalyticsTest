var TcHmi;!function(t){let e;!function(e){let s;!function(e){class s extends t.Controls.Analytics.AnalyticsControl{constructor(e,s,n){super(e,s,n),this.__vbWidth=620,this.__vbHeight=280,this.__svgSize={width:this.__vbWidth,height:this.__vbHeight},this.__onResolverForInputsWatchCallback=e=>{if(!1===this.__isAttached&&this.__suspendObjectResolver("SankeyInputs"),e.error!==t.Errors.NONE)return void t.Log.error("[Source=Control, Module=TcHmi.Controls.Analytics.SankeyChart, Id="+this.getId()+", Attribute=Inputs] Resolving symbols from object failed with error: "+t.Log.buildMessage(e.details));const s=null!=e.value?{name:e.value.name,value:e.value.percentage,percentage:100}:null;tchmi_equal(e.value,this.__sankeyInputs)||(this.__sankeyInputs=s,t.EventProvider.raise(`${this.__id}.onFunctionResultChanged`,["getResults"]),this.__processSankeyInputs())},this.__onResolverForSankeyInputsV2WatchCallback=e=>{!1===this.__isAttached&&this.__suspendObjectResolver("SankeyInputs"),e.error===t.Errors.NONE?tchmi_equal(e.value,this.__sankeyInputs)||(this.__sankeyInputsResolvedV2=e.value||null,t.EventProvider.raise(`${this.__id}.onFunctionResultChanged`,["getResults"]),this.__processSankeyInputsV2()):t.Log.error("[Source=Control, Module=TcHmi.Controls.Analytics.SankeyChart, Id="+this.getId()+", Attribute=Inputs] Resolving symbols from object failed with error: "+t.Log.buildMessage(e.details))},this.__onResolverForOutputsWatchCallback=e=>{this.__isAttached||this.__suspendObjectResolver("SankeyOutputs"),e.error===t.Errors.NONE?tchmi_equal(e.value,this.__sankeyOutputsResolved)||(this.__sankeyOutputsResolved=this.__migrateSankeyOutputs(e.value),t.EventProvider.raise(`${this.__id}.onFunctionResultChanged`,["getSankeyOutputsResolved"]),this.__processSankeyOutputs()):t.Log.error("[Source=Control, Module=TcHmi.Controls.Analytics.SankeyChart, Id="+this.getId()+", Attribute=Outputs] Resolving symbols from object failed with error: "+t.Log.buildMessage(e.details))},this.__onResized=()=>(t,e)=>{const s=super.__onResizedBase(t,e);s.valid&&0!=this.__hasLicense&&(this.__showReset?this.__elementNameAlias.css("padding-right","16px"):this.__elementNameAlias.css("padding-right","5px"),this.__svgSize.width=s.vpWidth,this.__svgSize.height=s.vpHeight,this.__elementSvg[0].setAttribute("viewBox",`0 0 ${s.vpWidth} ${s.vpHeight}`),this.__elementSvg[0].setAttribute("width",s.vpWidth.toString()),this.__elementSvg[0].setAttribute("height",s.vpHeight.toString()),this.__elementSvg[0].style.minWidth=s.vpWidth.toString(),this.__elementSvg[0].style.minHeight=s.vpHeight.toString(),this.__elementSvg[0].style.maxWidth=s.vpWidth.toString(),this.__elementSvg[0].style.maxHeight=s.vpHeight.toString(),this.__drawSankeyChart())}}__previnit(){super.__previnit(),0!=this.__hasLicense&&(this.__defaultWidth=630,this.__defaultHeight=310,this.__elementSvg=this.__elementTemplateRoot.find(".tchmi-sankey-chart-svg-chart"),this.__elementSvgDefs=this.__elementTemplateRoot.find(".tchmi-sankey-chart-defs-chart"),this.__elementSvgText=this.__elementTemplateRoot.find(".tchmi-sankey-chart-text"))}__init(){const t=[new e.Property(this,"Unit","Unit",e.E_DataType.STRING),new e.Property(this,"AmountDecimals","Amount Decimals",e.E_DataType.UINTEGER),new e.Property(this,"SankeyOutputs","Output Names",e.E_DataType.STRING,{subName:"name",subDisplayName:"Name"}),new e.Property(this,"StartColor","Start Color",e.E_DataType.SOLIDCOLOR),new e.Property(this,"EndColor","End Color",e.E_DataType.SOLIDCOLOR)];super.setEditableProperties(t),super.__init()}__attach(){super.__attach()}__detach(){super.__detach()}destroy(){this.__keepAlive||super.destroy()}setSankeyInputs(e){let s=t.ValueConverter.toObject(e);null===s&&(s=this.getAttributeDefaultValueInternal("SankeyInputs"));const n=this.__objectResolvers.get("SankeyInputs");n&&(n.watchDestroyer&&n.watchDestroyer(),n.resolver.destroy());const r=new t.Symbol.ObjectResolver(s);this.__objectResolvers.set("SankeyInputs",{resolver:r,watchCallback:this.__onResolverForInputsWatchCallback,watchDestroyer:r.watch(this.__onResolverForInputsWatchCallback)})}getSankeyInputs(){return this.__sankeyInputs}__processSankeyInputs(){this.__drawSankeyChart()}setSankeyInputsV2(e){let s=t.ValueConverter.toObject(e);if(null===s&&(s=this.getAttributeDefaultValueInternal("SankeyInputsV2")),s===this.__sankeyInputsV2)return;this.__sankeyInputsV2=s;const n=this.__objectResolvers.get("SankeyInputsV2");n&&(n.watchDestroyer&&n.watchDestroyer(),n.resolver.destroy());const r=new t.Symbol.ObjectResolver(s);this.__objectResolvers.set("SankeyInputsV2",{resolver:r,watchCallback:this.__onResolverForSankeyInputsV2WatchCallback,watchDestroyer:r.watch(this.__onResolverForSankeyInputsV2WatchCallback)})}getSankeyInputsV2(){return this.__sankeyInputsV2}__processSankeyInputsV2(){this.__drawSankeyChart()}setSankeyOutputs(e){let s=t.ValueConverter.toObject(e);if(null===s&&(s=this.getAttributeDefaultValueInternal("SankeyOutputs")),s===this.__sankeyOutputs)return;this.__sankeyOutputs=s;const n=this.__objectResolvers.get("SankeyOutputs");n&&(n.watchDestroyer&&n.watchDestroyer(),n.resolver.destroy());const r=new t.Symbol.ObjectResolver(s);this.__objectResolvers.set("SankeyOutputs",{resolver:r,watchCallback:this.__onResolverForOutputsWatchCallback,watchDestroyer:r.watch(this.__onResolverForOutputsWatchCallback)})}__migrateSankeyOutputs(t){if(t.length>0&&void 0===t[0].value){const e=(t=t).reduce((t,{percentage:e})=>t+e,0);for(const s of t)s.value=s.percentage,s.percentage=100*s.percentage/e}return t}getSankeyOutputsResolved(){return this.__sankeyOutputsResolved}getSankeyOutputs(){return this.__sankeyOutputs}__processSankeyOutputs(){this.__drawSankeyChart()}setRest(e){let s=t.ValueConverter.toNumber(e);null===s&&(s=this.getAttributeDefaultValueInternal("Rest")),s!==this.__rest&&(this.__rest=s,t.EventProvider.raise(`${this.__id}.onFunctionResultChanged`,["getRest"]),this.__processRest())}getRest(){return this.__rest}__processRest(){this.__drawSankeyChart()}setRestName(e){let s=t.ValueConverter.toString(e);null===s&&(s=this.getAttributeDefaultValueInternal("RestName")),s!==this.__restName&&(this.__restName=s,t.EventProvider.raise(`${this.__id}.onFunctionResultChanged`,["getRestName"]),this.__processRestName())}getRestName(){return this.__restName}__processRestName(){this.__drawSankeyChart()}setStartColor(e){let s=t.ValueConverter.toObject(e);null===s&&(s=this.getAttributeDefaultValueInternal("StartColor")),s!==this.__startColor&&(this.__startColor=s,t.EventProvider.raise(`${this.__id}.onFunctionResultChanged`,["getStartColor"]),this.__processStartColor())}getStartColor(){return this.__startColor}__processStartColor(){this.__drawSankeyChart()}setEndColor(e){let s=t.ValueConverter.toObject(e);null===s&&(s=this.getAttributeDefaultValueInternal("EndColor")),s!==this.__endColor&&(this.__endColor=s,t.EventProvider.raise(`${this.__id}.onFunctionResultChanged`,["getEndColor"]),this.__processEndColor())}getEndColor(){return this.__endColor}__processEndColor(){this.__drawSankeyChart()}setUnit(e){let s=t.ValueConverter.toString(e);null===s&&(s=this.getAttributeDefaultValueInternal("Unit")),s!==this.__unit&&(this.__unit=s,t.EventProvider.raise(`${this.__id}.onFunctionResultChanged`,["getUnit"]),this.__processUnit())}getUnit(){return this.__unit}__processUnit(){this.__drawSankeyChart()}__processAmountDecimals(){super.__processAmountDecimals(),this.__drawSankeyChart()}__processColor(){if(super.__processColor(),this.__elementSvgArrow=this.__elementTemplateRoot.find(".tchmi-sankey-chart-arrow"),null!=this.__startColor&&null!=this.__endColor&&null!=this.__sankeyOutputsResolved){const t=this.generateColor(this.__startColor.color,this.__endColor.color,this.__sankeyOutputsResolved.length+2);this.__elementSvgDefs[0].innerHTML="";for(let e=0;e<this.__elementSvgArrow.length;e++){const s=`linearGradSankey${this.__secureId}ArrowColor${e}`;this.CreateLinearGradientTwoColors(t[e],t[e+1],this.__elementSvgDefs[0],this.__colorGradient,s),this.__elementSvgArrow[e].setAttribute("fill",`url(#${s})`)}}this.__elementSvgText=this.__elementTemplateRoot.find(".tchmi-analytics-control-text"),this.__elementSvgText.css("fill",this.__fontColor)}__drawSankeyChart(){const t=this.__svgSize.width,s=this.__svgSize.height;if(!this.__attach||void 0===this.__sankeyInputsResolvedV2||void 0===this.__sankeyOutputsResolved||t<=0||s<=0)return;const n=t/this.__vbWidth,r=s/this.__vbHeight,i=n<1?16*(n/2+.5):16;$(this.__elementSvg[0].childNodes).not("defs").remove();let a=null!=this.__sankeyInputs?[this.__sankeyInputs]:this.__sankeyInputsResolvedV2,o=this.__sankeyOutputsResolved,l=a.reduce((t,{value:e})=>t+e,0),h=o.reduce((t,{value:e})=>t+e,0),_=l-h;const{unit:u,factor:c}=this.__getUnitAndFactor(l);l*=c,h*=c,_*=c,a=tchmi_clone_object(a),a.forEach(t=>t.value*=c),o=tchmi_clone_object(o),o.forEach(t=>t.value*=c);const d=o.length+1;let p=l;const m=.5*s-2,g=.1/r*n;let v=m*g;const y=t/(d+1)-(v/2+1);let S=m,k=!0,C=0,b=0,w=0,R=1-y;for(let t=0;t<d;t++){R+=y+w;const n=v+R;k&&(C=S/2+2,b=S+2),0!=t&&(p-=o[t-1].value,p>0?(k=!0,S=m*p/l):(k=!1,S=0)),v=S*g,t==d-1&&(v*=b/(S+2)),w=v/2+1;let r=y+R,h=r+v,c=S/2+2;const $=S+2,x=R+.3*y,A=R+.4*y;k||(r=x,h=x,c=C);const L=document.createElementNS("http://www.w3.org/2000/svg","path");if(L.classList.add("tchmi-sankey-chart-arrow"),0===t){const t=`\n                              M${R},2\n                              L${n},${C}\n                              L${R},${b}\n                              L${r},${$}\n                              L${h},${c}\n                              L${r},2\n                              L${R},2\n                              z`;L.setAttribute("d",t),this.__elementSvg[0].appendChild(L);let e=i;a.length>2&&(e/=(a.length-1)/1.6),this.__elementTemplateRoot[0].style.setProperty("--text-font-size",`${e}px`);const s=1.1*e,o=R+y/2;let _,d;for(let t=0;t<a.length;t++){const n=a[t];_=3*t*e,d=2+_,d+=s;const r=this.getTrimmedNumber(n.value),i=this.getTrimmedNumber(n.percentage,"",0),l=document.createElementNS("http://www.w3.org/2000/svg","text");if(l.classList.add("tchmi-sankey-chart-text","tchmi-sankey-chart-input-text","tchmi-analytics-control-text"),l.setAttribute("x",`${o}px`),l.setAttribute("y",`${d}px`),l.innerHTML=`${r} ${u}`,1===a.length?l.innerHTML=`${r} ${u}`:l.innerHTML=`${r} ${u} (${i}%)`,this.__elementSvg[0].appendChild(l),d+=s,""!=n.name){const t=document.createElementNS("http://www.w3.org/2000/svg","text");t.classList.add("tchmi-sankey-chart-text","tchmi-sankey-chart-input-text","tchmi-analytics-control-text"),t.setAttribute("x",`${o}px`),t.setAttribute("y",`${d}px`),t.innerHTML=n.name,this.__elementSvg[0].appendChild(t)}}if(a.length>1){const t=this.getTrimmedNumber(l),e=R+y/4,n=R+3*y/4;d+=s;const r=document.createElementNS("http://www.w3.org/2000/svg","line");r.style.strokeWidth="1px",r.classList.add("tchmi-analytics-svg-mask"),r.setAttribute("x1",`${e}px`),r.setAttribute("x2",`${n}px`),r.setAttribute("y1",`${d}px`),r.setAttribute("y2",`${d}px`),this.__elementSvg[0].appendChild(r),d+=s;const i=R+y/2,a=document.createElementNS("http://www.w3.org/2000/svg","text");a.classList.add("tchmi-sankey-chart-text","tchmi-sankey-chart-input-text","tchmi-analytics-control-text"),a.setAttribute("x",`${i}px`),a.setAttribute("y",`${d}px`),a.innerHTML=`${t} ${u} (100%)`,this.__elementSvg[0].appendChild(a)}}else{let a=b-$;const m=.2*S,g=A-x,k=A+g,w=g+a;let f;f=a>=0?`M${R},2\n                               L${n},${C}\n                               L${R},${b}\n                               L${x},${b}\n                               L${A},${b}\n                               A${g} ${g} 0 0 1 ${k} ${b+g}\n                               L${k},${b+m+g}\n                               L${k+a/2},${b+m+.33*a+g}\n                               L${k+a},${b+m+g}\n                               L${k+a},${b+g}\n                               A${w} ${w} 0 0 0 ${A} ${$}\n                               L${x},${$}\n                               L${r},${$}\n                               L${h},${c}\n                               L${r},2\n                               L${R},2z`:`M${R},2\n                               L${n},${C}\n                               L${R},${b}\n                               L${x},${b}\n                               L${A},${b}\n                               A${g} ${g} 0 0 1 ${k} ${b+g}\n                               \n                               L${R+g},${b+g}\n                               L${R+g+v},${($+b+g)/2}\n                               L${R+g},${$}\n\n                               L${r},${$}\n                               L${h},${c}\n                               L${r},2\n                               L${R},2z`,L.setAttribute("d",f),this.__elementSvg[0].appendChild(L);let I=k+a/2,O=b+m+.33*a+g+i;const W=1.1*i;O+=W;const N=this.getTrimmedNumber(o[t-1].value),T=this.getTrimmedNumber(o[t-1].percentage,"",0),E=document.createElementNS("http://www.w3.org/2000/svg","text");E.classList.add("tchmi-sankey-chart-text","tchmi-analytics-control-text"),E.setAttribute("x",`${I}px`),E.setAttribute("y",`${O}px`),E.innerHTML=`${N} ${u} (${T}%)`,this.__elementSvg[0].appendChild(E),O+=W/2;const D=Math.max(y,a);I-=D/2;const V=s-O,H=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");H.setAttribute("x",e.Str.px(I)),H.setAttribute("y",e.Str.px(O)),H.setAttribute("width",e.Str.px(D)),H.setAttribute("height",e.Str.px(V));const M=document.createElement("p");if(M.innerHTML=o[t-1].name,M.classList.add("tchmi-analytics-text","tchmi-sankey-chart-text"),H.appendChild(M),this.__elementSvg[0].appendChild(H),t==d-1&&(p>=.01||p<=-.01)&&Math.abs(p)/l>1e-4){const t=this.getTrimmedNumber(_),e=this.getTrimmedNumber(this.__rest,"",0),s=document.createElementNS("http://www.w3.org/2000/svg","text");s.classList.add("tchmi-sankey-chart-text","tchmi-analytics-control-text");const r=n+y/1.5;let a=2+1*i;if(a>S&&(a=S-1,a<2+i&&(a=2+i)),s.setAttribute("x",`${r}px`),s.setAttribute("y",`${a}px`),s.innerHTML=`${t} ${u} (${e}%)`,this.__elementSvg[0].appendChild(s),""!==this.__restName){a+=1*i;const t=document.createElementNS("http://www.w3.org/2000/svg","text");t.classList.add("tchmi-sankey-chart-text","tchmi-analytics-control-text"),t.setAttribute("x",`${r}px`),t.setAttribute("y",`${a}px`),t.innerHTML=this.__restName,this.__elementSvg[0].appendChild(t)}}}}this.__rest<-.01?super.drawWarning("Wrong configuration! Output values are overall greater than the input value."):super.removeWarning(),this.__elementsText=this.__elementTemplateRoot.find(".tchmi-analytics-text"),this.__processFontColor()}__getUnitAndFactor(t){let e=this.__unit;const s={W:1,Wh:1,kW:1e3,kWh:1e3,MW:1e6,MWh:1e6,GW:1e9,GWh:1e9};let n=1;if(void 0===s[e])return{unit:e,factor:n};n=s[e];const r=t*n;return r>=1e9?(e=e.includes("Wh")?"GWh":"GW",{unit:e,factor:n/s.GW}):r>=1e6?(e=e.includes("Wh")?"MWh":"MW",{unit:e,factor:n/s.MW}):r>=1e3?(e=e.includes("Wh")?"kWh":"kW",{unit:e,factor:n/s.kW}):(e=e.includes("Wh")?"Wh":"W",{unit:e,factor:n/s.W})}}e.SankeyChart=s}(s=e.Analytics||(e.Analytics={})),e.registerEx("SankeyChart","TcHmi.Controls.Analytics",s.SankeyChart)}(e=t.Controls||(t.Controls={}))}(TcHmi||(TcHmi={}));